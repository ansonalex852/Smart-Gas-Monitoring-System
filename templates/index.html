<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GasGuard ‚Äî IoT Monitoring</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:#0a0c10; --surface:#111318; --surface2:#181b22; --border:#232730;
      --accent:#00e5ff; --accent2:#ff3d3d; --accent3:#39ff14; --warn:#ffaa00;
      --text:#c8d0de; --text-dim:#4a5568;
      --mono:'Share Tech Mono',monospace; --body:'Exo 2',sans-serif;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--bg);color:var(--text);font-family:var(--body);min-height:100vh;overflow-x:hidden;}
    body::before{
      content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
      background-image:linear-gradient(rgba(0,229,255,.03) 1px,transparent 1px),
                       linear-gradient(90deg,rgba(0,229,255,.03) 1px,transparent 1px);
      background-size:40px 40px;
    }

    /* HEADER */
    header{
      position:relative;z-index:10;display:flex;align-items:center;justify-content:space-between;
      padding:18px 36px;border-bottom:1px solid var(--border);
      background:rgba(10,12,16,.92);backdrop-filter:blur(10px);
    }
    .logo{display:flex;align-items:center;gap:12px;}
    .logo-icon{
      width:38px;height:38px;background:var(--accent);
      clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
      display:flex;align-items:center;justify-content:center;font-size:18px;
      animation:pulse-icon 2s ease-in-out infinite;
    }
    @keyframes pulse-icon{0%,100%{box-shadow:0 0 0 0 rgba(0,229,255,.4);}50%{box-shadow:0 0 0 12px rgba(0,229,255,0);}}
    .logo-text{font-size:1.4rem;font-weight:800;letter-spacing:2px;color:#fff;}
    .logo-text span{color:var(--accent);}
    .header-right{display:flex;align-items:center;gap:20px;font-family:var(--mono);font-size:.78rem;color:var(--text-dim);}
    .live-badge{
      display:flex;align-items:center;gap:6px;background:rgba(57,255,20,.1);
      border:1px solid var(--accent3);border-radius:4px;padding:4px 10px;
      color:var(--accent3);font-size:.72rem;font-weight:600;letter-spacing:2px;
    }
    .live-dot{width:7px;height:7px;border-radius:50%;background:var(--accent3);animation:blink 1s step-end infinite;}
    @keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}
    #clock{font-family:var(--mono);font-size:.85rem;color:var(--accent);}

    /* ALERT BANNER */
    .alert-banner{
      position:relative;z-index:9;display:none;align-items:center;gap:14px;
      padding:14px 36px;background:rgba(255,61,61,.12);border-bottom:2px solid var(--accent2);
      color:var(--accent2);font-family:var(--mono);font-size:.9rem;font-weight:600;letter-spacing:1px;
      animation:flash-border .6s step-end infinite;
    }
    .alert-banner.active{display:flex;}
    @keyframes flash-border{0%,100%{border-color:var(--accent2);}50%{border-color:transparent;}}
    .alert-icon{font-size:1.3rem;animation:shake .4s infinite;}
    @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-3px);}75%{transform:translateX(3px);}}

    /* MAIN */
    main{position:relative;z-index:1;max-width:1300px;margin:0 auto;padding:36px 24px;
         display:grid;grid-template-columns:1fr 1fr;gap:24px;}

    /* CARD */
    .card{
      background:var(--surface);border:1px solid var(--border);border-radius:8px;
      padding:28px;position:relative;overflow:hidden;transition:border-color .3s;
    }
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);opacity:.6;}
    .card.danger{border-color:var(--accent2);}
    .card.danger::before{background:var(--accent2);opacity:1;}
    .card.safe::before{background:var(--accent3);opacity:1;}
    .card-label{
      font-family:var(--mono);font-size:.7rem;letter-spacing:3px;color:var(--text-dim);
      text-transform:uppercase;margin-bottom:20px;display:flex;align-items:center;gap:8px;
    }
    .card-label::before{content:'//';color:var(--accent);}

    /* GAS CARD */
    .gas-card{grid-column:1;}
    .status-display{display:flex;align-items:center;gap:20px;margin-bottom:24px;}
    .status-orb{
      width:90px;height:90px;border-radius:50%;border:3px solid var(--accent3);
      display:flex;align-items:center;justify-content:center;font-size:2.2rem;
      background:radial-gradient(circle,rgba(57,255,20,.15),transparent);
      box-shadow:0 0 30px rgba(57,255,20,.3),inset 0 0 30px rgba(57,255,20,.05);
      transition:all .5s;flex-shrink:0;
    }
    .status-orb.leak{
      border-color:var(--accent2);background:radial-gradient(circle,rgba(255,61,61,.2),transparent);
      box-shadow:0 0 40px rgba(255,61,61,.5),inset 0 0 30px rgba(255,61,61,.1);
      animation:orb-pulse .8s ease-in-out infinite;
    }
    @keyframes orb-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.08);}}
    .status-label{font-family:var(--mono);font-size:.72rem;color:var(--text-dim);letter-spacing:2px;}
    .status-value{font-family:var(--mono);font-size:2rem;font-weight:600;color:var(--accent3);transition:color .3s;}
    .status-value.leak{color:var(--accent2);}
    .status-sub{font-size:.8rem;color:var(--text-dim);margin-top:4px;}

    .section-title{font-family:var(--mono);font-size:.7rem;color:var(--text-dim);letter-spacing:2px;margin-bottom:8px;}
    .ppm-display{font-family:var(--mono);font-size:1.6rem;color:var(--accent);margin-bottom:12px;}
    .ppm-display span{font-size:.9rem;color:var(--text-dim);}
    .bar-track{height:14px;background:var(--surface2);border-radius:7px;overflow:hidden;border:1px solid var(--border);margin-bottom:6px;}
    .bar-fill{
      height:100%;border-radius:7px;background:linear-gradient(90deg,var(--accent3),var(--warn));
      transition:width 1s cubic-bezier(.4,0,.2,1),background .5s;position:relative;
    }
    .bar-fill.danger-zone{background:linear-gradient(90deg,var(--warn),var(--accent2));}
    .bar-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent 60%,rgba(255,255,255,.15));}
    .bar-markers{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.65rem;color:var(--text-dim);}
    .threshold-line{display:flex;align-items:center;gap:8px;margin-top:10px;font-family:var(--mono);font-size:.72rem;}
    .threshold-line .dot{width:8px;height:8px;border-radius:50%;background:var(--warn);}
    .threshold-line span{color:var(--text-dim);}
    .threshold-line strong{color:var(--warn);}

    /* WEIGHT CARD */
    .weight-card{grid-column:2;}
    .cylinder-wrap{display:flex;align-items:flex-end;gap:20px;}
    .cylinder-outer{width:70px;height:160px;border:2px solid var(--border);border-radius:8px 8px 4px 4px;background:var(--surface2);position:relative;overflow:hidden;flex-shrink:0;}
    .cylinder-fill{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(0deg,#0066cc,var(--accent));transition:height 1.5s cubic-bezier(.4,0,.2,1);opacity:.85;}
    .cylinder-fill.low{background:linear-gradient(0deg,#cc3300,var(--accent2));}
    .cylinder-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--mono);font-size:.65rem;color:rgba(255,255,255,.9);letter-spacing:1px;z-index:2;text-align:center;}
    .cylinder-ticks{display:flex;flex-direction:column;justify-content:space-between;height:160px;padding:2px 0;}
    .tick{display:flex;align-items:center;gap:4px;font-family:var(--mono);font-size:.62rem;color:var(--text-dim);}
    .tick-line{width:10px;height:1px;background:var(--border);}
    .weight-display{display:flex;align-items:flex-end;gap:8px;margin-bottom:14px;}
    .weight-value{font-family:var(--mono);font-size:4rem;font-weight:600;color:#fff;line-height:1;}
    .weight-unit{font-family:var(--mono);font-size:1.2rem;color:var(--accent);margin-bottom:10px;}
    .stats-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px;}
    .stat-box{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:14px;}
    .stat-box-label{font-family:var(--mono);font-size:.65rem;color:var(--text-dim);letter-spacing:2px;margin-bottom:6px;}
    .stat-box-value{font-family:var(--mono);font-size:1.1rem;color:var(--accent);}

    /* CHART */
    .chart-card{grid-column:1/-1;}
    .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
    .chart-legend{display:flex;gap:16px;font-family:var(--mono);font-size:.72rem;}
    .legend-item{display:flex;align-items:center;gap:6px;}
    .legend-dot{width:8px;height:8px;border-radius:50%;}
    canvas#chart{width:100%;height:180px;display:block;}

    /* LOG */
    .log-card{grid-column:1/-1;}
    .log-entries{max-height:200px;overflow-y:auto;font-family:var(--mono);font-size:.78rem;}
    .log-entries::-webkit-scrollbar{width:4px;}
    .log-entries::-webkit-scrollbar-track{background:var(--surface2);}
    .log-entries::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
    .log-entry{display:flex;gap:14px;padding:8px 0;border-bottom:1px solid var(--border);opacity:0;animation:fadeIn .4s forwards;}
    @keyframes fadeIn{to{opacity:1;}}
    .log-time{color:var(--text-dim);min-width:80px;}
    .log-type{min-width:60px;}
    .log-type.ok{color:var(--accent3);}
    .log-type.warn{color:var(--warn);}
    .log-type.err{color:var(--accent2);}
    .log-msg{color:var(--text);}

    /* CONTROLS */
    .controls-card{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;padding:20px 28px;}
    .ctrl-group{display:flex;gap:10px;align-items:center;}
    .ctrl-label{font-family:var(--mono);font-size:.72rem;color:var(--text-dim);letter-spacing:2px;}
    button{font-family:var(--mono);font-size:.78rem;padding:8px 18px;border-radius:4px;cursor:pointer;letter-spacing:1px;border:1px solid;transition:all .2s;}
    .btn-ghost{background:transparent;color:var(--text);border-color:var(--border);}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
    .threshold-input{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:7px 12px;color:var(--accent);font-family:var(--mono);font-size:.85rem;width:80px;text-align:center;}
    .threshold-input:focus{outline:none;border-color:var(--accent);}

    /* FB STATUS */
    .fb-status{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:.72rem;}
    .fb-dot{width:8px;height:8px;border-radius:50%;background:var(--warn);transition:background .3s;}
    .fb-dot.connected{background:var(--accent3);}
    .fb-dot.error{background:var(--accent2);}

    @media(max-width:768px){
      main{grid-template-columns:1fr;}
      .gas-card,.weight-card,.chart-card,.log-card,.controls-card{grid-column:1;}
      .controls-card{flex-direction:column;align-items:flex-start;}
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">‚¨°</div>
    <div class="logo-text">Gas<span>Guard</span></div>
  </div>
  <div class="header-right">
    <div class="fb-status">
      <div class="fb-dot" id="fbDot"></div>
      <span id="fbStatusText">CONNECTING...</span>
    </div>
    <div class="live-badge"><div class="live-dot"></div> LIVE</div>
    <div id="clock">--:--:--</div>
  </div>
</header>

<div class="alert-banner" id="alertBanner">
  <div class="alert-icon">‚ö†</div>
  <div>GAS LEAK DETECTED ‚Äî EVACUATE IMMEDIATELY ‚Äî VENTILATE AREA ‚Äî CHECK CONNECTIONS</div>
</div>

<main>

  <!-- GAS CARD -->
  <div class="card gas-card" id="gasCard">
    <div class="card-label">Gas Sensor (MQ2)</div>
    <div class="status-display">
      <div class="status-orb" id="statusOrb">üõ°Ô∏è</div>
      <div>
        <div class="status-label">CURRENT STATUS</div>
        <div class="status-value" id="statusValue">CHECKING...</div>
        <div class="status-sub" id="statusSub">Waiting for Firebase data</div>
      </div>
    </div>
    <div>
      <div class="section-title">// GAS CONCENTRATION (PPM)</div>
      <div class="ppm-display"><span id="ppmValue">--</span> <span>ppm</span></div>
      <div class="bar-track"><div class="bar-fill" id="gasBar" style="width:0%"></div></div>
      <div class="bar-markers"><span>0</span><span>250</span><span>500</span><span>750</span><span>1000</span></div>
      <div class="threshold-line">
        <div class="dot"></div>
        <span>Leak threshold: </span>
        <strong id="thresholdDisplay">300 ppm</strong>
      </div>
    </div>
  </div>

  <!-- WEIGHT CARD -->
  <div class="card weight-card" id="weightCard">
    <div class="card-label">LPG Cylinder Weight (Load Sensor)</div>
    <div class="cylinder-wrap">
      <div>
        <div class="cylinder-outer">
          <div class="cylinder-fill" id="cylinderFill" style="height:0%"></div>
          <div class="cylinder-label" id="cylinderPct">--%</div>
        </div>
      </div>
      <div class="cylinder-ticks">
        <div class="tick"><div class="tick-line"></div>14.2 kg</div>
        <div class="tick"><div class="tick-line"></div>10.6 kg</div>
        <div class="tick"><div class="tick-line"></div>7.1 kg</div>
        <div class="tick"><div class="tick-line"></div>3.6 kg</div>
        <div class="tick"><div class="tick-line"></div>0 kg</div>
      </div>
      <div>
        <div class="section-title">// LPG WEIGHT</div>
        <div class="weight-display">
          <div class="weight-value" id="weightValue">--</div>
          <div class="weight-unit">kg</div>
        </div>
        <div class="section-title">// TOTAL WEIGHT</div>
        <div style="font-family:var(--mono);font-size:1.1rem;color:var(--text-dim);margin-bottom:14px" id="totalWeight">-- kg</div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-box"><div class="stat-box-label">// CAPACITY</div><div class="stat-box-value" id="capacity">--%</div></div>
      <div class="stat-box"><div class="stat-box-label">// STATUS</div><div class="stat-box-value" id="lpgStatus" style="color:var(--text-dim)">CHECKING</div></div>
      <div class="stat-box"><div class="stat-box-label">// TARE WT.</div><div class="stat-box-value">14.6 kg</div></div>
      <div class="stat-box"><div class="stat-box-label">// MAX FILL</div><div class="stat-box-value">14.2 kg</div></div>
    </div>
  </div>

  <!-- CHART -->
  <div class="card chart-card">
    <div class="chart-header">
      <div class="card-label">Sensor History (Last 20 Readings)</div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div><span>Gas (ppm)</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--warn)"></div><span>Weight (kg)</span></div>
      </div>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <!-- CONTROLS -->
  <div class="card controls-card">
    <div class="ctrl-group">
      <div class="ctrl-label">LEAK THRESHOLD:</div>
      <input class="threshold-input" id="thresholdInput" type="number" value="300" min="50" max="999"/>
      <span style="font-family:var(--mono);font-size:.75rem;color:var(--text-dim)">ppm</span>
      <button class="btn-ghost" onclick="applyThreshold()">APPLY</button>
    </div>
    <div class="ctrl-group">
      <div class="ctrl-label">FIREBASE PATH:</div>
      <span style="font-family:var(--mono);font-size:.72rem;color:var(--accent)">/gasValue &amp; /weight</span>
    </div>
  </div>

  <!-- LOG -->
  <div class="card log-card">
    <div class="card-label">System Event Log</div>
    <div class="log-entries" id="logEntries"></div>
  </div>

</main>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üî• FIREBASE CONFIG ‚Äî Replace with your values
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var firebaseConfig = {
  apiKey: "AIzaSyD4ixkCRxPth2_LtQAHMOZyskLOzM5Vg0o",
  authDomain: "gas-guard-8bddf.firebaseapp.com",
  databaseURL: "https://gas-guard-8bddf-default-rtdb.firebaseio.com",
  projectId: "gas-guard-8bddf",
  storageBucket: "gas-guard-8bddf.firebasestorage.app",
  messagingSenderId: "1091804810949",
  appId: "1:1091804810949:web:b70a5f660d2242bd8b2aac",
  measurementId: "G-LSXS79BTVH"
};

// ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TARE = 14.6, MAX_LPG = 14.2, HISTORY_LEN = 20;
let threshold = 300, ppm = 0, lpgKg = 0, isLeak = false;
let ppmHistory = Array(HISTORY_LEN).fill(0);
let kgHistory  = Array(HISTORY_LEN).fill(0);
let fbConnected = false;

// ‚îÄ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(() => {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString();
}, 1000);

// ‚îÄ‚îÄ‚îÄ LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addLog(type, msg) {
  const el = document.getElementById('logEntries');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = `<span class="log-time">${new Date().toLocaleTimeString()}</span>
    <span class="log-type ${type}">[${type.toUpperCase()}]</span>
    <span class="log-msg">${msg}</span>`;
  el.prepend(entry);
  if (el.children.length > 40) el.removeChild(el.lastChild);
}

// ‚îÄ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
try {
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Connection state monitor
  firebase.database().ref('.info/connected').on('value', snap => {
    fbConnected = snap.val() === true;
    const dot = document.getElementById('fbDot');
    const txt = document.getElementById('fbStatusText');
    if (fbConnected) {
      dot.className = 'fb-dot connected';
      txt.textContent = 'FIREBASE: ONLINE';
      addLog('ok', 'Connected to Firebase Realtime Database');
    } else {
      dot.className = 'fb-dot error';
      txt.textContent = 'FIREBASE: OFFLINE';
      addLog('err', 'Firebase connection lost');
    }
  });

  // Gas value listener
  database.ref("GasSensor/value").on("value", snap => {
    const val = snap.val();
    if (val !== null) {
      ppm = Number(val) || 0;
      ppmHistory.push(ppm);
      if (ppmHistory.length > HISTORY_LEN) ppmHistory.shift();
      addLog('ok', `Gas reading received: ${ppm} ppm`);
      updateUI();
    }
  }, err => addLog('err', 'Gas sensor read error: ' + err.message));

  // Weight value listener
  database.ref("/weight").on("value", snap => {
    const val = snap.val();
    if (val !== null) {
      lpgKg = Number(val) || 0;
      kgHistory.push(lpgKg);
      if (kgHistory.length > HISTORY_LEN) kgHistory.shift();
      addLog('ok', `Weight reading received: ${lpgKg.toFixed(2)} kg`);
      updateUI();
    }
  }, err => addLog('err', 'Weight sensor read error: ' + err.message));

  addLog('ok', 'GasGuard initialized ‚Äî Firebase listeners attached');
  addLog('ok', 'Monitoring /gasValue and /weight paths');

} catch(e) {
  document.getElementById('fbDot').className = 'fb-dot error';
  document.getElementById('fbStatusText').textContent = 'FIREBASE: ERROR';
  addLog('err', 'Firebase init failed: ' + e.message);
  addLog('warn', 'Using placeholder values. Check your firebaseConfig.');
}

// ‚îÄ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('chart');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width  = canvas.offsetWidth  * devicePixelRatio;
  canvas.height = canvas.offsetHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
}

function drawChart() {
  const W = canvas.offsetWidth, H = canvas.offsetHeight;
  ctx.clearRect(0, 0, W, H);
  // Grid
  ctx.strokeStyle = 'rgba(35,39,48,.8)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = H * .05 + (H * .9 / 4) * i;
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }
  const pad = {l:10,r:10,t:10,b:10};
  const uW = W - pad.l - pad.r, uH = H - pad.t - pad.b;
  const n = HISTORY_LEN, stepX = uW / (n - 1);

  // Threshold line
  ctx.save(); ctx.strokeStyle='rgba(255,170,0,.5)'; ctx.setLineDash([6,4]); ctx.lineWidth=1;
  const ty = pad.t + uH - (threshold / 1000) * uH;
  ctx.beginPath(); ctx.moveTo(0,ty); ctx.lineTo(W,ty); ctx.stroke(); ctx.restore();

  function drawLine(data, maxVal, color) {
    ctx.save(); ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.shadowColor = color; ctx.shadowBlur = 8;
    ctx.beginPath();
    data.forEach((v, i) => {
      const x = pad.l + i * stepX;
      const y = pad.t + uH - (Math.min(v, maxVal) / maxVal) * uH;
      i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke();
    ctx.globalAlpha = .12; ctx.fillStyle = color;
    ctx.lineTo(pad.l+(n-1)*stepX, H-pad.b); ctx.lineTo(pad.l, H-pad.b);
    ctx.closePath(); ctx.fill(); ctx.restore();
  }

  drawLine(ppmHistory, 1000, '#00e5ff');
  drawLine(kgHistory.map(v => v * 10), 200, '#ffaa00');
}

// ‚îÄ‚îÄ‚îÄ UI UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateUI() {
  // Gas bar
  const pct = Math.min((ppm / 1000) * 100, 100);
  document.getElementById('ppmValue').textContent = ppm;
  const bar = document.getElementById('gasBar');
  bar.style.width = pct + '%';
  bar.className = 'bar-fill' + (ppm >= threshold ? ' danger-zone' : '');

  // Leak detection
  const leakNow = ppm >= threshold;
  if (leakNow !== isLeak) {
    isLeak = leakNow;
    addLog(isLeak ? 'err' : 'ok',
      isLeak ? `‚ö† LEAK DETECTED! ${ppm} ppm exceeds threshold of ${threshold} ppm`
             : `‚úî Gas level safe: ${ppm} ppm`);
  }

  const orb = document.getElementById('statusOrb');
  const val = document.getElementById('statusValue');
  const sub = document.getElementById('statusSub');
  const banner = document.getElementById('alertBanner');
  const gasCard = document.getElementById('gasCard');

  if (isLeak) {
    orb.textContent = '‚ò¢Ô∏è'; orb.className = 'status-orb leak';
    val.textContent = 'LEAK DETECTED'; val.className = 'status-value leak';
    sub.textContent = 'Danger! Evacuate and ventilate immediately';
    gasCard.className = 'card gas-card danger';
    banner.classList.add('active');
  } else {
    orb.textContent = 'üõ°Ô∏è'; orb.className = 'status-orb';
    val.textContent = 'NO LEAK'; val.className = 'status-value';
    sub.textContent = 'All readings within safe range';
    gasCard.className = 'card gas-card safe';
    banner.classList.remove('active');
  }

  // Weight
  const pctLPG = Math.min((lpgKg / MAX_LPG) * 100, 100);
  document.getElementById('weightValue').textContent = lpgKg.toFixed(2);
  document.getElementById('totalWeight').textContent = (lpgKg + TARE).toFixed(2) + ' kg';
  const fill = document.getElementById('cylinderFill');
  fill.style.height = pctLPG + '%';
  fill.className = 'cylinder-fill' + (pctLPG < 20 ? ' low' : '');
  document.getElementById('cylinderPct').textContent = Math.round(pctLPG) + '%';
  document.getElementById('capacity').textContent = Math.round(pctLPG) + '%';
  const ls = document.getElementById('lpgStatus');
  if (pctLPG < 10) { ls.textContent='EMPTY'; ls.style.color='var(--accent2)'; }
  else if (pctLPG < 20) { ls.textContent='LOW'; ls.style.color='var(--warn)'; }
  else { ls.textContent='ADEQUATE'; ls.style.color='var(--accent3)'; }

  drawChart();
}

// ‚îÄ‚îÄ‚îÄ THRESHOLD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyThreshold() {
  const val = parseInt(document.getElementById('thresholdInput').value);
  if (val >= 50 && val <= 999) {
    threshold = val;
    document.getElementById('thresholdDisplay').textContent = threshold + ' ppm';
    addLog('warn', `Leak threshold updated to ${threshold} ppm`);
    updateUI();
  } else {
    addLog('err', 'Invalid threshold. Must be between 50 and 999 ppm.');
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', () => { resizeCanvas(); drawChart(); });
resizeCanvas();
updateUI();
</script>
</body>
</html>